<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGenIT Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for chat window */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }

        .chat-message.user {
            background-color: #d1e7dd;
            align-self: flex-end;
            border-bottom-right-radius: 0;
            text-align: right;
        }

        .chat-message.bot {
            background-color: #f8f9fa;
            align-self: flex-start;
            border-bottom-left-radius: 0;
            text-align: left;
        }

        /* Ensure the main container for the chat window is centered and takes a good portion of the screen */
        #chat-window {
            height: calc(100vh - 200px); /* Adjust height to give space for header and footer */
            max-height: 800px; /* Max height to prevent it from getting too tall on large screens */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased flex flex-col items-center justify-center min-h-screen">

    <!-- Main Container -->
    <div class="w-full max-w-2xl mx-auto p-4 flex flex-col items-center">

        <!-- Header -->
        <div class="w-full bg-blue-600 text-white text-center py-4 rounded-t-xl shadow-lg">
            <h1 class="text-2xl font-bold">Welcome to NextGenIT</h1>
        </div>

        <!-- Lead Form -->
        <div id="lead-form" class="w-full bg-white p-6 rounded-b-xl shadow-lg">
            <form class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="phone" name="phone" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Submit
                </button>
            </form>
        </div>

        <!-- Thank you message -->
        <div id="thankyou-msg" class="hidden w-full bg-white p-6 rounded-b-xl shadow-lg text-center text-gray-700">
            <p class="text-lg font-semibold">Thank you! A representative will contact you shortly.</p>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="hidden w-full bg-white rounded-b-xl shadow-lg flex flex-col">
            <!-- Chat Box -->
            <div id="chat-box" class="flex-grow p-4 overflow-y-auto space-y-4 flex flex-col">
                <!-- Chat messages will be appended here dynamically -->
            </div>

            <!-- Chat Input Form -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <input type="text" id="msg" placeholder="Ask me anything..." class="flex-grow rounded-full border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="send" class="bg-blue-600 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.917H17.5a.75.75 0 010 1.5H4.984l-2.432 7.917a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="w-full bg-blue-600 text-white text-center py-4 rounded-b-xl shadow-lg mt-4">
            <h2 class="text-lg">Contact Us @ sales@nextgenit.in</h2>
        </div>
    </div>

    <!-- The widget.js script for the chat functionality -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    // Grab elements
    const leadForm = document.getElementById("lead-form");
    const chatWindow = document.getElementById("chat-window");
    const chatBox = document.getElementById("chat-box");
    const thankyouMsg = document.getElementById("thankyou-msg");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const phoneInput = document.getElementById("phone");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("send");

    // Backend URL auto-detect
    let FLASK_URL;
    if (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") {
        FLASK_URL = "http://127.0.0.1:8000";
    } else {
        FLASK_URL = window.location.origin;
    }
    console.log("ðŸ‘‰ Using backend:", FLASK_URL);

    // Verify DOM elements at load
    console.log("Initial DOM check:", { leadForm, thankyouMsg, chatWindow, chatBox, nameInput, emailInput, phoneInput, msgInput, sendBtn });

    // Append message
    function appendMessage(text, sender = "bot") {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("chat-message", sender, "max-w-[75%]", "rounded-xl", "px-4", "py-2", "shadow-sm");

        // Use a simple regex to convert common markdown to HTML
        let formattedText = text;
        
        // Convert bold markdown (**text**) to HTML <strong>
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Convert bullet points to an unordered list
        formattedText = formattedText.replace(/(\s*)- (.+?)(?=\n-|$)/g, '<li>$2</li>');
        if (formattedText.includes('<li>')) {
            formattedText = `<ul>${formattedText}</ul>`;
        }

        // Convert newlines to breaks
        formattedText = formattedText.replace(/\n/g, '<br>');

        msgDiv.innerHTML = formattedText;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return msgDiv;
    }

    // Append bot reply with feedback buttons
    function appendBotReply(data) {
        const msgDiv = appendMessage(data.final_answer || "No answer.", "bot");
        const fbDiv = document.createElement("div");
        fbDiv.classList.add("feedback-buttons", "flex", "mt-2", "space-x-2");
        const upBtn = document.createElement("button");
        upBtn.textContent = "ðŸ‘";
        upBtn.classList.add("thumb-up", "text-lg", "p-1");
        const downBtn = document.createElement("button");
        downBtn.textContent = "ðŸ‘Ž";
        downBtn.classList.add("thumb-down", "text-lg", "p-1");
        fbDiv.appendChild(upBtn);
        fbDiv.appendChild(downBtn);
        msgDiv.appendChild(fbDiv);
        upBtn.addEventListener("click", async () => {
            await sendFeedback("good", data);
            fbDiv.remove();
        });
        downBtn.addEventListener("click", async () => {
            await sendFeedback("bad", data);
            fbDiv.remove();
        });
    }

    // Feedback API call
    async function sendFeedback(sentiment, data) {
        try {
            await fetch(`${FLASK_URL}/feedback`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sentiment,
                    question: data.user_question,
                    final_answer: data.final_answer,
                    rag_output: data.rag_output,
                    llm_output: data.llm_output,
                    rag_scores: data.rag_scores
                })
            });
            console.log(`Feedback (${sentiment}) sent for:`, data.user_question);
        } catch (err) {
            console.error("Feedback failed:", err);
        }
    }

    // Lead form
    leadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Verify DOM elements
        if (!leadForm || !thankyouMsg || !chatWindow) {
            console.error("DOM elements missing:", { leadForm, thankyouMsg, chatWindow });
            alert("Form error: UI elements not found. Check console for details.");
            return;
        }

        const lead = {
            name: nameInput.value.trim(),
            email: emailInput.value.trim(),
            phone: phoneInput.value.trim()
        };

        if (!lead.name || !lead.email || !lead.phone) {
            alert("Please fill in all lead fields.");
            return;
        }

        console.log("Submitting lead to:", FLASK_URL, lead);

        try {
            const response = await fetch(`${FLASK_URL}/submit_lead`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Cache-Control": "no-cache"
                },
                body: JSON.stringify(lead)
            });

            console.log("HTTP status:", response.status, "OK:", response.ok);

            if (!response.ok) {
                console.error("HTTP error:", response.status, response.statusText);
                alert(`Failed to submit lead: HTTP ${response.status} ${response.statusText}`);
                return;
            }

            const result = await response.json();
            console.log("Backend response:", result);

            if (result.status === "success" || result.status === "ok" || (response.ok && result.status !== "error")) {
                console.log("Success: Hiding form, showing thank-you message");
                leadForm.classList.add("hidden");
                thankyouMsg.classList.remove("hidden");
                console.log("thankyouMsg classList:", thankyouMsg.classList.toString());
                console.log("thankyouMsg visibility:", window.getComputedStyle(thankyouMsg).display);
                setTimeout(() => {
                    console.log("Timeout: Hiding thank-you message, showing chat window");
                    thankyouMsg.classList.add("hidden");
                    chatWindow.classList.remove("hidden");
                    console.log("chatWindow classList:", chatWindow.classList.toString());
                    console.log("chatWindow visibility:", window.getComputedStyle(chatWindow).display);
                }, 2000); // Changed to 5 seconds
            } else {
                console.error("Lead save error:", result);
                alert(`Error saving lead: ${result.message || JSON.stringify(result) || "Unknown error"}`);
            }
        } catch (err) {
            console.error("Lead submission failed:", err.message, err.stack);
            alert(`Failed to submit lead: ${err.message}. Check console for details.`);
        }
    });

    // Chat send
    sendBtn.addEventListener("click", async () => {
        const message = msgInput.value.trim();
        if (!message) {
            alert("Please type a message before sending.");
            return;
        }

        appendMessage(message, "user");
        msgInput.value = "";
        const thinkingMsg = appendMessage("Bot is thinking...", "bot");

        try {
            const response = await fetch(`${FLASK_URL}/chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });

            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const data = await response.json();

            thinkingMsg.remove();

            if (data.status === "error") {
                appendMessage("Error: " + data.message, "bot");
                console.error("Bot error:", data.message);
            } else {
                data.user_question = message;
                const formattedReply = (data.final_answer || "")
                    .replace(/Email:\s*(\S+)/gi, "âœ‰ï¸ Email: $1")
                    .replace(/Phone:\s*(\S+)/gi, "ðŸ“ž Phone: $1");
                data.final_answer = formattedReply;
                appendBotReply(data);
            }
        } catch (err) {
            console.error("Chat failed:", err);
            thinkingMsg.remove();
            appendMessage("Failed to get response from bot.", "bot");
        }
    });

    // Press Enter to send
    msgInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendBtn.click();
    });

    console.log("widget.js loaded successfully");
});
    </script>
</body>
</html>
